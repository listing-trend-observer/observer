<!DOCTYPE html>
<html>
<head>
    <title>DVC Intelligence Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 20px; background: #f8f9fa; color: #333; }
        .container { max-width: 1300px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .metric-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .metric { font-size: 28px; font-weight: bold; color: #1a73e8; }
        .label { font-size: 13px; color: #666; text-transform: uppercase; font-weight: 600; margin-bottom: 5px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; height: 380px; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f1f3f4; font-weight: 600; position: sticky; top: 0; }
        tr:hover { background: #fafafa; }
        
        .badge-new { background: #e8f0fe; color: #1967d2; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-drop { background: #fce8e6; color: #d93025; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; border: 1px solid #d93025; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        
        select { padding: 12px; border-radius: 8px; border: 1px solid #dfe1e5; width: 100%; font-size: 16px; outline: none; transition: border 0.3s; }
        select:focus { border-color: #1a73e8; }
    </style>
</head>
<body>
    <div class="container">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h1>DVC Market Intelligence</h1>
            <div style="width: 350px;">
                <label class="label">Resort Focus</label>
                <select id="resortFilter">
                    <option value="All">All Resorts (Market Overview)</option>
                </select>
            </div>
        </header>

        <div class="metric-row">
            <div class="card"><div class="label">Total Active</div><div id="totalListings" class="metric">--</div></div>
            <div class="card"><div class="label">Avg Price / Pt</div><div id="avgPrice" class="metric">--</div></div>
            <div class="card"><div class="label">Sold Since Yesterday</div><div id="soldCount" class="metric">--</div></div>
            <div class="card"><div class="label">Market Velocity</div><div id="velocity" class="metric">--</div></div>
        </div>

        <div class="grid">
            <div class="chart-container"><canvas id="inventoryChart"></canvas></div>
            <div class="chart-container"><canvas id="priceTrendChart"></canvas></div>
        </div>

        <div class="card" style="overflow-x: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Live Listing Feed</h2>
                <span style="color: #666; font-size: 13px;">Sorted by Best Value (Price/Pt)</span>
            </div>
            <table>
                <thead>
                    <tr><th>Resort</th><th>Points</th><th>Price/Pt</th><th>Days on Market</th><th>Market Status</th></tr>
                </thead>
                <tbody id="listingBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let fullData = [];
        let inventoryChart, priceTrendChart;

        Papa.parse('./data/listings_history.csv', {
            download: true, header: true,
            complete: function(results) {
                fullData = results.data.filter(d => d.date && d.listing_id);
                if(fullData.length > 0) {
                    initFilter();
                    updateDashboard("All");
                }
            }
        });

        function initFilter() {
            const selector = document.getElementById('resortFilter');
            const resorts = [...new Set(fullData.map(d => d.resort))].filter(r => r).sort();
            resorts.forEach(r => {
                let opt = document.createElement('option');
                opt.value = r; opt.innerHTML = r;
                selector.appendChild(opt);
            });
            selector.addEventListener('change', (e) => updateDashboard(e.target.value));
        }

        function updateDashboard(selectedResort) {
            const dates = [...new Set(fullData.map(d => d.date))].sort();
            const latestDate = dates[dates.length - 1];
            const prevDate = dates[dates.length - 2] || latestDate;

            const filteredData = selectedResort === "All" ? fullData : fullData.filter(d => d.resort === selectedResort);
            const latestListings = filteredData.filter(d => d.date === latestDate);
            const prevListings = filteredData.filter(d => d.date === prevDate);

            // Metrics
            const total = latestListings.length;
            const avg = latestListings.reduce((s, c) => s + parseFloat(c.price_per_point.replace('$','')), 0) / (total || 1);
            const latestIDs = new Set(latestListings.map(l => l.listing_id));
            const solds = prevListings.filter(l => !latestIDs.has(l.listing_id));
            
            document.getElementById('totalListings').innerText = total;
            document.getElementById('avgPrice').innerText = `$${avg.toFixed(2)}`;
            document.getElementById('soldCount').innerText = solds.length;
            document.getElementById('velocity').innerText = total > 0 ? ((solds.length / total) * 100).toFixed(1) + "%" : "0%";

            renderCharts(filteredData, dates, selectedResort);
            renderTable(latestListings, prevListings);
        }

        function renderCharts(data, dates, selectedResort) {
            if (inventoryChart) inventoryChart.destroy();
            if (priceTrendChart) priceTrendChart.destroy();

            const resorts = selectedResort === "All" ? [...new Set(data.map(d => d.resort))].filter(r => r) : [selectedResort];
            
            // Inventory Trend Line
            inventoryChart = new Chart(document.getElementById('inventoryChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: resorts.map(r => ({
                        label: r,
                        data: dates.map(dt => data.filter(d => d.date === dt && d.resort === r).length),
                        tension: 0.3, pointRadius: 4
                    }))
                },
                options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Inventory Volume (How many are available?)' } } }
            });

            // Price Trend Line
            priceTrendChart = new Chart(document.getElementById('priceTrendChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: resorts.map(r => ({
                        label: r,
                        data: dates.map(dt => {
                            const dayData = data.filter(d => d.date === dt && d.resort === r);
                            if (dayData.length === 0) return null;
                            const sum = dayData.reduce((s, d) => s + parseFloat(d.price_per_point.replace('$','')), 0);
                            return (sum / dayData.length).toFixed(2);
                        }),
                        tension: 0.3, borderDash: [5, 5]
                    }))
                },
                options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Avg Price Trend (What is the value doing?)' } } }
            });
        }

        function renderTable(listings, prevListings) {
            const body = document.getElementById('listingBody');
            body.innerHTML = "";
            
            listings.sort((a,b) => parseFloat(a.price_per_point.replace('$','')) - parseFloat(b.price_per_point.replace('$','')));

            listings.slice(0, 100).forEach(item => {
                const daysOnMarket = fullData.filter(d => d.listing_id === item.listing_id).length;
                let status = daysOnMarket === 1 ? '<span class="badge-new">NEW LISTING</span>' : '';
                
                const yesterday = prevListings.find(p => p.listing_id === item.listing_id);
                if (yesterday) {
                    const current = parseFloat(item.price_per_point.replace('$',''));
                    const old = parseFloat(yesterday.price_per_point.replace('$',''));
                    if (current < old) status = `<span class="badge-drop">ðŸ“‰ DROP: -$${(old - current).toFixed(2)}</span>`;
                }

                body.innerHTML += `<tr>
                    <td><strong>${item.resort}</strong></td>
                    <td>${item.points}</td>
                    <td>${item.price_per_point}</td>
                    <td>${daysOnMarket} Day(s)</td>
                    <td>${status}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>
