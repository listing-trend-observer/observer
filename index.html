<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC Intelligence | Market Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --bg: #f0f2f5; --card-bg: #ffffff; --text: #202124; --text-sub: #5f6368; --primary: #1a73e8; --border: #e0e0e0; --hover: #f8f9fa; --shadow: 0 4px 20px rgba(0,0,0,0.08); }
        [data-theme="dark"] { --bg: #121212; --card-bg: #1e1e1e; --text: #e8eaed; --text-sub: #9aa0a6; --primary: #8ab4f8; --border: #3c4043; --hover: #2d2d2d; --shadow: 0 4px 20px rgba(0,0,0,0.3); }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); transition: background 0.3s ease, color 0.3s ease; }
        .container { max-width: 1400px; margin: auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .theme-toggle { cursor: pointer; padding: 10px 20px; border-radius: 30px; border: 2px solid var(--primary); background: transparent; color: var(--primary); font-weight: bold; transition: all 0.2s; }
        .theme-toggle:hover { background: var(--primary); color: white; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--card-bg); padding: 24px; border-radius: 16px; box-shadow: var(--shadow); border: 1px solid var(--border); }
        .metric { font-size: 32px; font-weight: 800; color: var(--primary); margin-top: 5px; }
        .label { font-size: 11px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .chart-container { background: var(--card-bg); padding: 20px; border-radius: 16px; height: 380px; border: 1px solid var(--border); box-shadow: var(--shadow); }
        select { padding: 12px; border-radius: 10px; border: 2px solid var(--border); background: var(--card-bg); color: var(--text); font-size: 16px; width: 100%; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th.sortable { text-align: left; font-size: 12px; color: var(--text-sub); padding: 12px; border-bottom: 2px solid var(--border); cursor: pointer; }
        th.sortable:hover { color: var(--primary); }
        th.sortable::after { content: ' â†•'; opacity: 0.3; font-size: 10px; margin-left: 5px; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:hover { background: var(--hover); }
        .listing-link { color: var(--primary); text-decoration: none; font-weight: 600; }
        .listing-link:hover { text-decoration: underline; }
        .badge-new { background: rgba(26, 115, 232, 0.1); color: #1a73e8; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; }
        .badge-drop { background: rgba(217, 48, 37, 0.1); color: #d93025; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; border: 1px solid #d93025; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DVC Intel Dashboard</h1>
            <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Change Theme</button>
        </header>
        <div class="card" style="margin-bottom: 25px;">
            <label class="label">Resort Filter</label>
            <select id="resortFilter"><option value="All">All Resorts (Market Overview)</option></select>
        </div>
        <div class="grid">
            <div class="card"><div class="label">Live Listings</div><div id="totalListings" class="metric">--</div></div>
            <div class="card"><div class="label">Avg Price / Pt</div><div id="avgPrice" class="metric">--</div></div>
            <div class="card"><div class="label">Sold (Past 24h)</div><div id="soldCount" class="metric">--</div></div>
        </div>
        <div class="grid">
            <div class="chart-container"><canvas id="inventoryChart"></canvas></div>
            <div class="chart-container"><canvas id="priceTrendChart"></canvas></div>
        </div>
        <div class="card" style="overflow-x: auto;">
            <h2>Market Feed</h2>
            <table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="handleSort('listing_id')">ID</th>
                        <th class="sortable" onclick="handleSort('resort')">Resort</th>
                        <th class="sortable" onclick="handleSort('points')">Points</th>
                        <th class="sortable" onclick="handleSort('price_per_point')">Price/Pt</th>
                        <th class="sortable" onclick="handleSort('days')">Days</th>
                        <th>Insight</th>
                    </tr>
                </thead>
                <tbody id="listingBody"></tbody>
            </table>
        </div>
    </div>
    <script>
        let fullData = [];
        let inventoryChart, priceTrendChart;
        let currentSort = { column: 'price_per_point', direction: 'asc' };
        const colorPalette = ['#1a73e8', '#34a853', '#fabc05', '#ea4335', '#673ab7', '#ff6d01', '#00bcd4'];

        // Helper to map Resort Names to URL slugs
        const resortSlugs = {
            "Animal Kingdom": "animal-kingdom-lodge", "Aulani": "aulani-disney-resort", "Bay Lake Tower": "bay-lake-tower",
            "Beach Club": "beach-club-villas", "BoardWalk": "boardwalk-villas", "Boulder Ridge": "boulder-ridge-villas",
            "Copper Creek": "copper-creek-villas", "Grand Californian": "grand-californian", "Grand Floridian": "grand-floridian",
            "Hilton Head": "hilton-head", "Old Key West": "old-key-west", "Polynesian": "polynesian", "Riviera": "riviera-resort",
            "Saratoga Springs": "saratoga-springs", "Vero Beach": "vero-beach"
        };

        function toggleTheme() {
            const html = document.documentElement;
            const theme = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', theme);
            updateDashboard(document.getElementById('resortFilter').value);
        }

        Papa.parse('./data/listings_history.csv', {
            download: true, header: true,
            complete: function(results) {
                fullData = results.data.filter(d => d.date && d.listing_id);
                if(fullData.length > 0) { initFilter(); updateDashboard("All"); }
            }
        });

        function initFilter() {
            const selector = document.getElementById('resortFilter');
            const resorts = [...new Set(fullData.map(d => d.resort))].filter(r => r).sort();
            resorts.forEach(r => {
                let opt = document.createElement('option');
                opt.value = r; opt.innerHTML = r;
                selector.appendChild(opt);
            });
            selector.addEventListener('change', (e) => updateDashboard(e.target.value));
        }

        function handleSort(col) {
            if (currentSort.column === col) currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            else { currentSort.column = col; currentSort.direction = 'asc'; }
            updateDashboard(document.getElementById('resortFilter').value);
        }

        function updateDashboard(selected) {
            const dates = [...new Set(fullData.map(d => d.date))].sort();
            const latestDate = dates[dates.length - 1];
            const prevDate = dates[dates.length - 2] || latestDate;
            const filtered = selected === "All" ? fullData : fullData.filter(d => d.resort === selected);
            const latest = filtered.filter(d => d.date === latestDate);
            const prev = filtered.filter(d => d.date === prevDate);

            document.getElementById('totalListings').innerText = latest.length;
            const avg = latest.reduce((s, c) => s + parseFloat(c.price_per_point.replace('$','')), 0) / (latest.length || 1);
            document.getElementById('avgPrice').innerText = `$${avg.toFixed(2)}`;
            const latestIDs = new Set(latest.map(l => l.listing_id));
            document.getElementById('soldCount').innerText = prev.filter(l => !latestIDs.has(l.listing_id)).length;

            renderCharts(filtered, dates, selected);
            renderTable(latest, prev);
        }

        function renderCharts(data, dates, selected) {
            if (inventoryChart) inventoryChart.destroy();
            if (priceTrendChart) priceTrendChart.destroy();
            const resorts = selected === "All" ? [...new Set(data.map(d => d.resort))].filter(r => r) : [selected];
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            const opt = { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: isDark ? '#e8eaed' : '#5f6368' } } }, scales: { x: { grid: { display: false } }, y: { grid: { color: isDark ? '#3c4043' : '#e0e0e0' } } } };

            inventoryChart = new Chart(document.getElementById('inventoryChart'), { type: 'line', data: { labels: dates, datasets: resorts.map((r, i) => ({ label: r, data: dates.map(dt => data.filter(d => d.date === dt && d.resort === r).length), borderColor: colorPalette[i % 7], tension: 0.4 })) }, options: opt });
            priceTrendChart = new Chart(document.getElementById('priceTrendChart'), { type: 'line', data: { labels: dates, datasets: resorts.map((r, i) => ({ label: r, data: dates.map(dt => { const day = data.filter(d => d.date === dt && d.resort === r); return day.length ? (day.reduce((s, d) => s + parseFloat(d.price_per_point.replace('$','')), 0) / day.length).toFixed(2) : null; }), borderColor: colorPalette[i % 7], borderDash: [5, 5], tension: 0.4 })) }, options: opt });
        }

        function renderTable(listings, prevListings) {
            const body = document.getElementById('listingBody'); body.innerHTML = "";
            listings.sort((a, b) => {
                let vA, vB;
                if (currentSort.column === 'price_per_point') { vA = parseFloat(a.price_per_point.replace('$','')); vB = parseFloat(b.price_per_point.replace('$','')); }
                else if (currentSort.column === 'points') { vA = parseInt(a.points); vB = parseInt(b.points); }
                else if (currentSort.column === 'days') { vA = fullData.filter(d => d.listing_id === a.listing_id).length; vB = fullData.filter(d => d.listing_id === b.listing_id).length; }
                else { vA = (a[currentSort.column] || "").toLowerCase(); vB = (b[currentSort.column] || "").toLowerCase(); }
                return currentSort.direction === 'asc' ? (vA > vB ? 1 : -1) : (vA < vB ? 1 : -1);
            });

            listings.slice(0, 100).forEach(item => {
                const days = fullData.filter(d => d.listing_id === item.listing_id).length;
                let insight = days === 1 ? '<span class="badge-new">NEW</span>' : '';
                const yest = prevListings.find(p => p.listing_id === item.listing_id);
                if (yest) {
                    const diff = parseFloat(yest.price_per_point.replace('$','')) - parseFloat(item.price_per_point.replace('$',''));
                    if (diff > 0) insight = `<span class="badge-drop">ðŸ“‰ -$${diff.toFixed(2)}</span>`;
                }

                const slug = resortSlugs[item.resort] || item.resort.toLowerCase().replace(/ /g, '-');
                const url = `https://www.dvcresalemarket.com/listings/${slug}/${item.listing_id.toLowerCase().trim()}/`;

                body.innerHTML += `<tr>
                    <td style="font-family: monospace; font-size: 12px;">${item.listing_id}</td>
                    <td><a href="${url}" target="_blank" class="listing-link">${item.resort}</a></td>
                    <td>${item.points}</td><td>${item.price_per_point}</td><td>${days}</td><td>${insight}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>
