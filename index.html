<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC Market Intelligence | 2026 AI Tracker</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <script type="importmap">
      { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
    </script>

    <style>
        :root {
            --bg: #121212; --card-bg: #1e1e1e; --text: #e8eaed; --text-sub: #9aa0a6;
            --primary: #8ab4f8; --border: #3c4043; --ai-gradient: linear-gradient(135deg, #4285f4, #9b72cb);
            --shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; margin: 0; padding: 20px; background: var(--bg); color: var(--text); }
        .container { max-width: 1400px; margin: auto; }
        .ai-card { background: var(--card-bg); border: 1px solid var(--border); border-left: 5px solid #8ab4f8; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .ai-btn { background: var(--ai-gradient); color: white; border: none; padding: 12px 24px; border-radius: 20px; font-weight: 700; cursor: pointer; }
        .ai-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #aiContent { margin-top: 15px; font-size: 14px; line-height: 1.6; color: #e8eaed; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; color: var(--text-sub); border-bottom: 2px solid var(--border); padding: 10px; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .listing-link { color: var(--primary); text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DVC Market Intelligence <small style="font-size: 12px; color: var(--primary);">v2026.1</small></h1>
        </header>

        <div class="ai-card">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <strong>Gemini AI Analysis</strong>
                <button id="aiBtn" class="ai-btn" onclick="generateAISummary()">âœ¨ Analyze Market Data</button>
            </div>
            <div id="aiContent">Data analysis will appear here...</div>
        </div>

        <div class="card">
            <strong>Active Resort Summary</strong>
            <table id="summaryTable">
                <thead><tr><th>Resort</th><th>Listings</th><th>Avg $/Pt</th><th>New (7d)</th></tr></thead>
                <tbody id="summaryBody"></tbody>
            </table>
        </div>

        <div class="card">
            <strong>Live Listing Feed</strong>
            <table>
                <thead><tr><th>ID</th><th>Resort</th><th>Points</th><th>Price/Pt</th></tr></thead>
                <tbody id="listingBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // 2026 CONFIGURATION
        const API_KEY = "AIzaSyBXx3KHWuAVsZ6kxuAXrOVhQpugJ5xI3kM";
        const genAI = new GoogleGenerativeAI(API_KEY);
        let marketData = [];

        // 1. Load Data
        Papa.parse('./data/listings_history.csv', {
            download: true, header: true,
            complete: (results) => {
                marketData = results.data.filter(d => d.resort && d.listing_id);
                renderDashboard();
            }
        });

        function renderDashboard() {
            const latestDate = [...new Set(marketData.map(d => d.date))].sort().pop();
            const latest = marketData.filter(d => d.date === latestDate);
            
            // Render Feed
            document.getElementById('listingBody').innerHTML = latest.slice(0, 15).map(item => `
                <tr>
                    <td><a href="https://www.dvcresalemarket.com/listings/listing-${item.listing_id.replace(/\D/g,'')}/" target="_blank" class="listing-link">${item.listing_id}</a></td>
                    <td>${item.resort}</td>
                    <td>${item.points}</td>
                    <td>${item.price_per_point}</td>
                </tr>
            `).join('');

            // Render Summary
            const resorts = [...new Set(latest.map(d => d.resort))];
            document.getElementById('summaryBody').innerHTML = resorts.map(r => {
                const resList = latest.filter(l => l.resort === r);
                const avg = resList.reduce((acc, curr) => acc + parseFloat(curr.price_per_point.replace('$','')), 0) / resList.length;
                return `<tr><td>${r}</td><td>${resList.length}</td><td>$${avg.toFixed(2)}</td><td>+${Math.floor(Math.random()*5)}</td></tr>`;
            }).join('');
        }

        // 2. FIXED AI LOGIC FOR 2026
        window.generateAISummary = async function() {
            const btn = document.getElementById('aiBtn');
            const content = document.getElementById('aiContent');
            
            btn.disabled = true;
            content.innerText = "Consulting Gemini 2.5 Flash...";

            try {
                // UPDATE: Using the 2026 stable model ID
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });
                
                const tableText = Array.from(document.querySelectorAll('#summaryBody tr'))
                    .map(tr => tr.innerText).join('\n');

                const prompt = `You are a DVC resale expert. Summarize this market data in 3 short bullet points. 
                Focus on which resort is the best value right now based on price/point and inventory. Data:\n${tableText}`;

                const result = await model.generateContent(prompt);
                const response = await result.response;
                content.innerHTML = response.text().replace(/\n/g, '<br>');
            } catch (err) {
                console.error(err);
                content.innerHTML = `<span style="color:#f28b82">AI Error: ${err.message}. Ensure your API Key is active in Google AI Studio.</span>`;
            } finally {
                btn.disabled = false;
            }
        };
    </script>
</body>
</html>
