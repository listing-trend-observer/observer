<!DOCTYPE html>
<html>
<head>
    <title>DVC Intelligence Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; margin: 20px; background: #f8f9fa; color: #333; }
        .container { max-width: 1200px; margin: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .metric { font-size: 24px; font-weight: bold; color: #1a73e8; }
        .label { font-size: 14px; color: #666; text-transform: uppercase; margin-bottom: 10px; }
        .chart-container { background: white; padding: 20px; border-radius: 12px; height: 350px; position: relative; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f1f3f4; font-weight: 600; }
        .badge-new { background: #e8f0fe; color: #1967d2; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DVC Market Intelligence</h1>

        <div class="card" style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
            <label for="resortFilter" style="font-weight: bold;">Filter by Resort:</label>
            <select id="resortFilter" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; flex-grow: 1;">
                <option value="All">All Resorts (Market Overview)</option>
            </select>
        </div>

        <div class="grid">
            <div class="card"><div class="label">Total Active</div><div id="totalListings" class="metric">--</div></div>
            <div class="card"><div class="label">Avg Price (Selected)</div><div id="avgPrice" class="metric">--</div></div>
            <div class="card"><div class="label">Sold Since Yesterday</div><div id="soldCount" class="metric">--</div></div>
        </div>

        <div class="grid">
            <div class="chart-container"><canvas id="inventoryChart"></canvas></div>
            <div class="chart-container"><canvas id="priceDistChart"></canvas></div>
        </div>

        <div class="card">
            <h2>Live Market Feed</h2>
            <table>
                <thead>
                    <tr><th>Resort</th><th>Points</th><th>Price/Pt</th><th>Days on Market</th><th>Insight</th></tr>
                </thead>
                <tbody id="listingBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let fullData = [];
        let inventoryChart, priceDistChart;

        // Use './' to ensure GitHub Pages finds the file relative to the index.html
        Papa.parse('./data/listings_history.csv', {
            download: true, header: true,
            complete: function(results) {
                fullData = results.data.filter(d => d.date);
                if(fullData.length > 0) {
                    setupFilter(fullData);
                    updateDashboard("All");
                }
            }
        });

        function setupFilter(data) {
            const selector = document.getElementById('resortFilter');
            const resorts = [...new Set(data.map(d => d.resort))].filter(r => r).sort();
            resorts.forEach(r => {
                let opt = document.createElement('option');
                opt.value = r; opt.innerHTML = r;
                selector.appendChild(opt);
            });
            selector.addEventListener('change', (e) => updateDashboard(e.target.value));
        }

        function updateDashboard(selectedResort) {
            const dates = [...new Set(fullData.map(d => d.date))].sort();
            const latestDate = dates[dates.length - 1];
            const prevDate = dates[dates.length - 2] || latestDate;

            const filteredData = selectedResort === "All" ? fullData : fullData.filter(d => d.resort === selectedResort);
            const latestListings = filteredData.filter(d => d.date === latestDate);
            const prevListings = filteredData.filter(d => d.date === prevDate);

            // Metrics
            document.getElementById('totalListings').innerText = latestListings.length;
            const avg = latestListings.reduce((s, c) => s + parseFloat(c.price_per_point.replace('$','')), 0) / (latestListings.length || 1);
            document.getElementById('avgPrice').innerText = `$${avg.toFixed(2)}`;

            // Sold Logic
            const latestIDs = new Set(latestListings.map(l => l.listing_id));
            const solds = prevListings.filter(l => !latestIDs.has(l.listing_id));
            document.getElementById('soldCount').innerText = solds.length;

            updateCharts(filteredData, dates, selectedResort, latestListings);
            updateTable(latestListings);
        }

        function updateCharts(data, dates, selectedResort, latestListings) {
            if (inventoryChart) inventoryChart.destroy();
            if (priceDistChart) priceDistChart.destroy();

            const resorts = selectedResort === "All" ? [...new Set(data.map(d => d.resort))].filter(r => r) : [selectedResort];
            
            inventoryChart = new Chart(document.getElementById('inventoryChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: resorts.map(r => ({
                        label: r,
                        data: dates.map(dt => data.filter(d => d.date === dt && d.resort === r).length),
                        tension: 0.3
                    }))
                },
                options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Inventory Trend' } } }
            });

            const prices = latestListings.map(l => parseFloat(l.price_per_point.replace('$','')));
            priceDistChart = new Chart(document.getElementById('priceDistChart'), {
                type: 'bar',
                data: {
                    labels: ['<$100', '$100-120', '$120-140', '$140-160', '>$160'],
                    datasets: [{
                        label: 'Listings',
                        data: [
                            prices.filter(p => p < 100).length,
                            prices.filter(p => p >= 100 && p < 120).length,
                            prices.filter(p => p >= 120 && p < 140).length,
                            prices.filter(p => p >= 140 && p < 160).length,
                            prices.filter(p => p >= 160).length,
                        ],
                        backgroundColor: '#1a73e8'
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function updateTable(listings) {
            const tableBody = document.getElementById('listingBody');
            tableBody.innerHTML = "";
            listings.slice(0, 20).forEach(item => {
                const daysOnMarket = fullData.filter(d => d.listing_id === item.listing_id).length;
                tableBody.innerHTML += `<tr>
                    <td>${item.resort}</td>
                    <td>${item.points}</td>
                    <td>${item.price_per_point}</td>
                    <td>${daysOnMarket} Day(s)</td>
                    <td>${daysOnMarket === 1 ? '<span class="badge-new">NEW</span>' : ''}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>
