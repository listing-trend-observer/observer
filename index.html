<!DOCTYPE html>
<html>
<head>
    <title>DVC Price Observer</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; margin: 40px; background: #f0f2f5; color: #1c1e21; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        h1, h2 { color: #1a73e8; text-align: center; }
        .chart-container { margin-bottom: 50px; height: 400px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th { background-color: #f8f9fa; color: #5f6368; text-align: left; padding: 12px; border-bottom: 2px solid #dee2e6; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background-color: #f1f3f4; }
        .badge { background: #34a853; color: white; padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 11px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>DVC Price Observer</h1>
        
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>

        <hr>

        <h2>âœ¨ New Listings Today</h2>
        <table id="newTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Resort</th>
                    <th>Points</th>
                    <th>Price/Pt</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="newTableBody">
                </tbody>
        </table>
    </div>

    <script>
        const csvUrl = 'data/listings_history.csv';
        
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                const data = results.data.filter(d => d.date);
                const dates = [...new Set(data.map(item => item.date))].sort();
                const latestDate = dates[dates.length - 1];
                const previousDate = dates[dates.length - 2];

                // 1. Draw the Chart
                const resorts = [...new Set(data.map(item => item.resort))].filter(r => r);
                const datasets = resorts.map(resort => {
                    return {
                        label: resort,
                        data: dates.map(date => {
                            const dayData = data.filter(d => d.date === date && d.resort === resort);
                            if (dayData.length === 0) return null;
                            const total = dayData.reduce((sum, d) => sum + parseFloat(d.price_per_point.replace('$', '')), 0);
                            return (total / dayData.length).toFixed(2);
                        }),
                        borderWidth: 2, tension: 0.3, fill: false
                    };
                });

                new Chart(document.getElementById('priceChart'), {
                    type: 'line',
                    data: { labels: dates, datasets: datasets },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // 2. Find New Listings (IDs in latestDate that weren't in previousDate)
                const latestIDs = data.filter(d => d.date === latestDate);
                const previousIDs = new Set(data.filter(d => d.date === previousDate).map(d => d.listing_id));
                
                const tableBody = document.getElementById('newTableBody');
                latestIDs.forEach(item => {
                    if (!previousIDs.has(item.listing_id)) {
                        const row = `<tr>
                            <td>#${item.listing_id}</td>
                            <td>${item.resort}</td>
                            <td>${item.points}</td>
                            <td>${item.price_per_point}</td>
                            <td><span class="badge">NEW</span></td>
                        </tr>`;
                        tableBody.innerHTML += row;
                    }
                });
                
                if (tableBody.innerHTML === "") {
                    tableBody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No new listings found in this update.</td></tr>";
                }
            }
        });
    </script>
</body>
</html>
