<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DVC Intelligence | Market Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #202124;
            --text-sub: #5f6368;
            --primary: #1a73e8;
            --border: #e0e0e0;
            --hover: #f8f9fa;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        [data-theme="dark"] {
            --bg: #121212;
            --card-bg: #1e1e1e;
            --text: #e8eaed;
            --text-sub: #9aa0a6;
            --primary: #8ab4f8;
            --border: #3c4043;
            --hover: #2d2d2d;
            --shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; padding: 20px;
            background: var(--bg);
            color: var(--text);
            transition: background 0.3s ease, color 0.3s ease;
            line-height: 1.5;
        }

        .container { max-width: 1400px; margin: auto; }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .theme-toggle {
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 30px;
            border: 2px solid var(--primary);
            background: transparent;
            color: var(--primary);
            font-weight: bold;
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 20px; margin-bottom: 30px; }

        .card { 
            background: var(--card-bg); 
            padding: 24px; 
            border-radius: 16px; 
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        .metric { font-size: 32px; font-weight: 800; color: var(--primary); margin-top: 5px; }
        .label { font-size: 11px; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }

        .chart-container { background: var(--card-bg); padding: 20px; border-radius: 16px; height: 380px; border: 1px solid var(--border); box-shadow: var(--shadow); }

        select {
            padding: 12px; border-radius: 10px; border: 2px solid var(--border);
            background: var(--card-bg); color: var(--text); font-size: 16px; width: 100%;
            cursor: pointer; outline: none;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th.sortable { 
            text-align: left; font-size: 12px; color: var(--text-sub); 
            padding: 12px; border-bottom: 2px solid var(--border); 
            cursor: pointer; transition: color 0.2s;
        }
        th.sortable:hover { color: var(--primary); }
        th.sortable::after { content: ' â†•'; opacity: 0.3; font-size: 10px; }
        
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        tr:hover { background: var(--hover); }

        .badge-new { background: rgba(26, 115, 232, 0.1); color: #1a73e8; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; }
        .badge-drop { background: rgba(217, 48, 37, 0.1); color: #d93025; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 800; border: 1px solid #d93025; }

        h1 { margin: 0; font-weight: 800; letter-spacing: -1px; }
        h2 { margin-top: 0; font-size: 18px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>DVC Intel Dashboard</h1>
            <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“ Change Theme</button>
        </header>

        <div class="card" style="margin-bottom: 25px;">
            <label class="label">Resort Filter</label>
            <select id="resortFilter">
                <option value="All">All Resorts (Market Overview)</option>
            </select>
        </div>

        <div class="grid">
            <div class="card"><div class="label">Live Listings</div><div id="totalListings" class="metric">--</div></div>
            <div class="card"><div class="label">Avg Price / Pt</div><div id="avgPrice" class="metric">--</div></div>
            <div class="card"><div class="label">Sold (Past 24h)</div><div id="soldCount" class="metric">--</div></div>
        </div>

        <div class="grid">
            <div class="chart-container"><canvas id="inventoryChart"></canvas></div>
            <div class="chart-container"><canvas id="priceTrendChart"></canvas></div>
        </div>

        <div class="card" style="overflow-x: auto;">
            <h2>Market Feed</h2>
            <table>
                <thead>
                    <tr>
                        <th class="sortable" onclick="handleSort('resort')">Resort</th>
                        <th class="sortable" onclick="handleSort('points')">Points</th>
                        <th class="sortable" onclick="handleSort('price_per_point')">Price/Pt</th>
                        <th class="sortable" onclick="handleSort('days')">Days</th>
                        <th>Insight</th>
                    </tr>
                </thead>
                <tbody id="listingBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let fullData = [];
        let inventoryChart, priceTrendChart;
        let currentSort = { column: 'price_per_point', direction: 'asc' };
        const colorPalette = ['#1a73e8', '#34a853', '#fabc05', '#ea4335', '#673ab7', '#ff6d01', '#00bcd4'];

        function toggleTheme() {
            const body = document.body;
            const theme = body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', theme);
            
            // Update Chart.js defaults for the new theme
            Chart.defaults.color = theme === 'dark' ? '#e8eaed' : '#5f6368';
            updateDashboard(document.getElementById('resortFilter').value);
        }

        // Load Data
        Papa.parse('./data/listings_history.csv', {
            download: true, 
            header: true,
            complete: function(results) {
                fullData = results.data.filter(d => d.date && d.listing_id);
                if(fullData.length > 0) {
                    initFilter();
                    updateDashboard("All");
                }
            }
        });

        function initFilter() {
            const selector = document.getElementById('resortFilter');
            const resorts = [...new Set(fullData.map(d => d.resort))].filter(r => r).sort();
            resorts.forEach(r => {
                let opt = document.createElement('option');
                opt.value = r; opt.innerHTML = r;
                selector.appendChild(opt);
            });
            selector.addEventListener('change', (e) => updateDashboard(e.target.value));
        }

        function handleSort(column) {
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            updateDashboard(document.getElementById('resortFilter').value);
        }

        function updateDashboard(selectedResort) {
            const dates = [...new Set(fullData.map(d => d.date))].sort();
            const latestDate = dates[dates.length - 1];
            const prevDate = dates[dates.length - 2] || latestDate;

            const filteredData = selectedResort === "All" ? fullData : fullData.filter(d => d.resort === selectedResort);
            const latestListings = filteredData.filter(d => d.date === latestDate);
            const prevListings = filteredData.filter(d => d.date === prevDate);

            // Metrics calculation
            document.getElementById('totalListings').innerText = latestListings.length;
            const avg = latestListings.reduce((s, c) => s + parseFloat(c.price_per_point.replace('$','')), 0) / (latestListings.length || 1);
            document.getElementById('avgPrice').innerText = `$${avg.toFixed(2)}`;

            const latestIDs = new Set(latestListings.map(l => l.listing_id));
            const solds = prevListings.filter(l => !latestIDs.has(l.listing_id));
            document.getElementById('soldCount').innerText = solds.length;

            renderCharts(filteredData, dates, selectedResort);
            renderTable(latestListings, prevListings);
        }

        function renderCharts(data, dates, selectedResort) {
            if (inventoryChart) inventoryChart.destroy();
            if (priceTrendChart) priceTrendChart.destroy();

            const resorts = selectedResort === "All" ? [...new Set(data.map(d => d.resort))].filter(r => r) : [selectedResort];
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            
            const commonOptions = {
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, padding: 20 } } },
                scales: { 
                    x: { grid: { display: false }, ticks: { maxRotation: 45, minRotation: 45 } }, 
                    y: { grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' } } 
                }
            };

            inventoryChart = new Chart(document.getElementById('inventoryChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: resorts.map((r, i) => ({
                        label: r,
                        data: dates.map(dt => data.filter(d => d.date === dt && d.resort === r).length),
                        borderColor: colorPalette[i % colorPalette.length],
                        backgroundColor: colorPalette[i % colorPalette.length] + '22',
                        fill: selectedResort !== "All",
                        tension: 0.4
                    }))
                },
                options: { ...commonOptions, plugins: { ...commonOptions.plugins, title: { display: true, text: 'Inventory Volume Trend' } } }
            });

            priceTrendChart = new Chart(document.getElementById('priceTrendChart'), {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: resorts.map((r, i) => ({
                        label: r + " Avg Price",
                        data: dates.map(dt => {
                            const dayData = data.filter(d => d.date === dt && d.resort === r);
                            if (dayData.length === 0) return null;
                            const sum = dayData.reduce((s, d) => s + parseFloat(d.price_per_point.replace('$','')), 0);
                            return (sum / dayData.length).toFixed(2);
                        }),
                        borderColor: colorPalette[i % colorPalette.length],
                        borderDash: [5, 5],
                        tension: 0.4
                    }))
                },
                options: { ...commonOptions, plugins: { ...commonOptions.plugins, title: { display: true, text: 'Price Per Point History' } } }
            });
        }

        function renderTable(listings, prevListings) {
            const body = document.getElementById('listingBody');
            body.innerHTML = "";

            // Custom Sort Engine
            listings.sort((a, b) => {
                let valA, valB;
                if (currentSort.column === 'price_per_point') {
                    valA = parseFloat(a.price_per_point.replace('$', ''));
                    valB = parseFloat(b.price_per_point.replace('$', ''));
                } else if (currentSort.column === 'points') {
                    valA = parseInt(a.points);
                    valB = parseInt(b.points);
                } else if (currentSort.column === 'days') {
                    valA = fullData.filter(d => d.listing_id === a.listing_id).length;
                    valB = fullData.filter(d => d.listing_id === b.listing_id).length;
                } else {
                    valA = a[currentSort.column].toLowerCase();
                    valB = b[currentSort.column].toLowerCase();
                }
                return currentSort.direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
            });

            listings.slice(0, 50).forEach(item => {
                const daysOnMarket = fullData.filter(d => d.listing_id === item.listing_id).length;
                let insight = daysOnMarket === 1 ? '<span class="badge-new">NEW</span>' : '';
                
                const yesterday = prevListings.find(p => p.listing_id === item.listing_id);
                if (yesterday) {
                    const current = parseFloat(item.price_per_point.replace('$',''));
                    const old = parseFloat(yesterday.price_per_point.replace('$',''));
                    if (current < old) insight = `<span class="badge-drop">ðŸ“‰ -$${(old - current).toFixed(2)}</span>`;
                }

                body.innerHTML += `<tr>
                    <td><strong>${item.resort}</strong></td>
                    <td>${item.points}</td>
                    <td>${item.price_per_point}</td>
                    <td>${daysOnMarket}</td>
                    <td>${insight}</td>
                </tr>`;
            });
        }
    </script>
</body>
</html>
