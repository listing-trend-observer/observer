<body>
    <div class="container">
        <h1>DVC Market Intelligence</h1>

        <div class="card" style="margin-bottom: 20px; display: flex; align-items: center; gap: 15px;">
            <label for="resortFilter" style="font-weight: bold;">Filter by Resort:</label>
            <select id="resortFilter" style="padding: 8px; border-radius: 6px; border: 1px solid #ccc; flex-grow: 1;">
                <option value="All">All Resorts (Market Overview)</option>
                </select>
        </div>

        <div class="grid">
            <div class="card">
                <div class="label">Total Active Listings</div>
                <div id="totalListings" class="metric">--</div>
            </div>
            <div class="card">
                <div class="label">Avg Price (Selected)</div>
                <div id="avgPrice" class="metric">--</div>
            </div>
            <div class="card">
                <div class="label">Sold Since Yesterday</div>
                <div id="soldCount" class="metric">--</div>
            </div>
        </div>

        <div class="grid">
            <div class="chart-container">
                <canvas id="inventoryChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="priceDistChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h2 id="tableTitle">Live Market Feed</h2>
            <table id="listingTable">
                <thead>
                    <tr>
                        <th>Resort</th>
                        <th>Points</th>
                        <th>Price/Pt</th>
                        <th>Days on Market</th>
                        <th>Insight</th>
                    </tr>
                </thead>
                <tbody id="listingBody"></tbody>
            </table>
        </div>
    </div>

    <script>
        let fullData = [];
        let inventoryChart, priceDistChart;

        Papa.parse('data/listings_history.csv', {
            download: true, header: true,
            complete: function(results) {
                fullData = results.data.filter(d => d.date);
                setupFilter(fullData);
                updateDashboard("All");
            }
        });

        function setupFilter(data) {
            const selector = document.getElementById('resortFilter');
            const resorts = [...new Set(data.map(d => d.resort))].filter(r => r).sort();
            resorts.forEach(r => {
                let opt = document.createElement('option');
                opt.value = r;
                opt.innerHTML = r;
                selector.appendChild(opt);
            });

            selector.addEventListener('change', (e) => updateDashboard(e.target.value));
        }

        function updateDashboard(selectedResort) {
            const dates = [...new Set(fullData.map(d => d.date))].sort();
            const latestDate = dates[dates.length - 1];
            const previousDate = dates[dates.length - 2];

            // Filter data based on selection
            const filteredData = selectedResort === "All" 
                ? fullData 
                : fullData.filter(d => d.resort === selectedResort);

            const latestListings = filteredData.filter(d => d.date === latestDate);
            const prevListings = filteredData.filter(d => d.date === previousDate);

            // --- 1. METRICS UPDATE ---
            document.getElementById('totalListings').innerText = latestListings.length;
            const avg = latestListings.reduce((s, c) => s + parseFloat(c.price_per_point.replace('$','')), 0) / (latestListings.length || 1);
            document.getElementById('avgPrice').innerText = `$${avg.toFixed(2)}`;

            // SOLD LOGIC: IDs present yesterday but not today
            const latestIDs = new Set(latestListings.map(l => l.listing_id));
            const solds = prevListings.filter(l => !latestIDs.has(l.listing_id));
            document.getElementById('soldCount').innerText = solds.length;

            // --- 2. UPDATE CHARTS ---
            updateInventoryChart(filteredData, dates, selectedResort);
            updatePriceDist(latestListings);

            // --- 3. UPDATE TABLE ---
            const tableBody = document.getElementById('listingBody');
            tableBody.innerHTML = "";
            latestListings.slice(0, 20).forEach(item => {
                const daysOnMarket = fullData.filter(d => d.listing_id === item.listing_id).length;
                tableBody.innerHTML += `<tr>
                    <td>${item.resort}</td>
                    <td>${item.points}</td>
                    <td>${item.price_per_point}</td>
                    <td>${daysOnMarket} Day(s)</td>
                    <td>${daysOnMarket === 1 ? '<span class="badge-new">NEW</span>' : ''}</td>
                </tr>`;
            });
        }

        function updateInventoryChart(data, dates, selectedResort) {
            if (inventoryChart) inventoryChart.destroy();
            const ctx = document.getElementById('inventoryChart').getContext('2d');
            
            // If "All", show stacked resorts. If specific, show just that one.
            const resorts = selectedResort === "All" ? [...new Set(data.map(d => d.resort))].filter(r => r) : [selectedResort];
            
            inventoryChart = new Chart(ctx, {
                type: 'line',
